# APA WebGPU 加速自动泊车仿真器

## 系统要求

- **浏览器**: Chrome 113+ / Edge 113+ (必须支持 WebGPU)
- **显卡**: 推荐 NVIDIA RTX 4090 (任何支持 WebGPU 的显卡均可)
- **开启 WebGPU**: Chrome 默认已开启；如未生效，访问 `chrome://flags/#enable-unsafe-webgpu` 开启

## 快速开始

1. 双击打开 `apa-webgpu.html`
2. 左上角查看 GPU 状态指示灯：
   - 🟣 紫色 = WebGPU 已激活（使用你的 4090）
   - 🔴 红色 = 降级为 CPU 模式
3. 点击 **▶ 开始** 按钮，车辆自动规划路径并泊入车位

## 核心功能

### 🎮 四种泊车场景
| 按钮 | 场景 | 说明 |
|------|------|------|
| ★ 侧方位 | 平行泊车 | 两车之间侧方停车 |
| ★ 垂直位 | 垂直泊车 | 90° 垂直倒车入库 |
| ★ 斜向位 | 斜向泊车 | 60° 斜列式车位 |
| ★ 压力测试 | 10个障碍物 | 含3个移动行人+自行车+推车 |

### 📡 传感器系统 (行业标准配置)
- **前向 LiDAR**: 1个, 180° FOV, 25m 探测距离
- **超声波雷达 (USS)**: 12个
  - 前保险杠 4 个: 左角 FL / 左中 FCL / 右中 FCR / 右角 FR
  - 后保险杠 4 个: 左角 RL / 左中 RCL / 右中 RCR / 右角 RR
  - 左侧面 2 个: 前B柱 SFL / 后C柱 SRL
  - 右侧面 2 个: 前B柱 SFR / 后C柱 SRR
- 每个 USS 扇区 FOV 60°~70°，探测距离 5m

### 🎯 严格泊车验证
泊车完成时系统自动验证三项指标：
- **航向偏差**: 车身与车位方向的夹角（默认容差 ≤2°）
- **横向偏差**: 车辆中心偏离车位中心线距离（默认容差 ≤15cm）
- **压线检测**: 车辆四角到车位线的最近距离（默认容差 ≥-5cm）

右上角会显示详细评分卡：`✅ 泊车合格` 或 `❌ 泊车不合格`

### ⚡ 进化优化器 (遗传算法)
自动寻找最优泊车策略的核心功能：

1. 设置参数：
   - **种群**: 每代多少个候选方案 (建议 12~20)
   - **代数**: 迭代几轮 (建议 4~8)
   - **权重**: 调整优化偏好
     - 时间权重: 越高越追求快速泊车
     - 距离权重: 越高越追求短路径
     - 揉库权重: 越高越减少前后挪动次数
     - 偏差权重: 越高越追求精准对齐

2. 点击 **⚡ 启动进化**
3. 观察进化日志，每代显示：适应度、耗时、距离、揉库次数、评分
4. 完成后点击 **✓ 应用最优** 将最佳路径加载到仿真器

### 🖱️ 编辑器操作
| 操作 | 方法 |
|------|------|
| 移动视图 | 按住空格键 + 拖拽 |
| 缩放 | 鼠标滚轮 |
| 移动物体 | 选择模式下拖拽 |
| 放置车辆 | 选择"⊕ 车辆"工具后点击 |
| 添加障碍物 | 选择"▪ 矩形"/"● 圆形"后点击 |
| 添加动态障碍 | 选择"◎ 动态"后点击（自带速度的行人） |
| 设置车位 | 选择"⊟ 车位"后点击 |
| 删除物体 | 选中后按 Delete 键 |

### 🔧 可调参数
- **传感器**: LiDAR距离/FOV、USS距离、重规划周期
- **车辆**: 车长/宽/轴距/前后悬/转角/膨胀半径
- **规划器**: 最大规划时间、速度、网格精度
- **泊车验证**: 航向/横向/压线容差

## GPU 加速原理

### WebGPU 构型空间 (C-Space)
- 将整个 (x, y, θ) 三维空间离散化为 ~100万个格点
- GPU 计算着色器并行执行 SAT 矩形碰撞检测
- 4090 上预计 **2~5ms** 生成完整碰撞地图
- A* 搜索时碰撞检查变为 O(1) 数组查表

### 性能对比
| | CPU 逐点碰撞 | GPU C-Space |
|--|--|--|
| 碰撞检测/次 | ~1μs (SAT) | O(1) 查表 |
| 网格生成 | ~700ms | ~3ms (4090) |
| 动态重规划 | 卡顿明显 | 流畅 |
| 10个障碍物 | 无法实时 | 5ms 以内 |

### 可视化 C-Space
开启"显示C-Space"后，紫色区域为当前航向角下的碰撞禁区，可直观看到可通行空间。

## 文件说明

单文件 `apa-webgpu.html`，零依赖，双击即用。
所有代码（WebGPU 着色器、传感器仿真、规划器、进化器、渲染器）均内嵌于此文件。

## 故障排除

1. **GPU 指示灯红色**
   - 检查浏览器是否为 Chrome/Edge 最新版
   - 访问 `chrome://gpu` 确认 WebGPU 状态
   - 尝试 `chrome://flags/#enable-unsafe-webgpu`

2. **规划失败 (无路径)**
   - 检查车位空间是否足够 (车位宽度需 > 车长 + 1m)
   - 尝试调大"网格精度"值 (如 0.6)
   - 调大"最大时间" (如 30s)

3. **泊车不合格**
   - 运行进化优化器，自动寻找更精准的路径
   - 调大偏差权重，进化器会更重视对齐精度
